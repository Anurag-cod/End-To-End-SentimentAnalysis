version: 2.1
jobs:
  continuous_integration:
    machine: true
    resource_class: anurag/sentimentrunner
    steps:
      - checkout
      - run:
          name: verify environment
          command: |
            echo "=== Docker version ==="
            docker --version
            echo "=== Current directory ==="
            pwd
            echo "=== Files ==="
            ls -la
      - run:
          name: build docker image
          command: |
            docker build -t sentimentdemo:latest . || exit 1
      - run:
          name: cleanup old containers
          command: |
            docker stop sentimentdemo 2>/dev/null || true
            docker rm sentimentdemo 2>/dev/null || true
      - run:
          name: run new container
          command: |
            docker run -d --name sentimentdemo -p 8080:8080 sentimentdemo:latest
      - run:
          name: verify container is running
          command: |
            sleep 5
            docker ps | grep sentimentdemo
workflows:
  CICD:
    jobs:
      - continuous_integration